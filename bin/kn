#!/usr/bin/perl
use v5.10; use strict; use warnings;

if (!$ENV{'KN'}) {
  say 'KN environment variable must be set to current node path.';
  exit 1;
}

use Cwd;
use File::Basename;
use File::Spec;

my ($abscmd, $absdir, $absknd, $knd, $action, $action_path, %actions);

$abscmd = Cwd::abs_path($0);
$absdir = dirname($abscmd);
$absknd = File::Spec->join($absdir,'kn.d');
$knd = File::Spec->join($ENV{'KN'},'.kn.d');
$action = shift;

-d $knd or $knd = '';

# --------------------------- builtin actions -------------------------

sub _foo {
  say 'foo';
}

my %builtin = (
  "_foo" => \&_foo
);

# load up all the standard actions that ship with command

foreach my $a (map {s,^.*/,, && $_} glob "$absknd/*") {
  $actions{$a} = File::Spec->join($absknd,$a);
}

# override with any actions that are in the root node

if ($knd) {
  foreach my $a (map {s,^.*/,, && $_} glob "$knd/*") {
    $actions{$a} = File::Spec->join($knd,$a);
  }
}

# add internal builtins to completion (override all others)
# TODO

# ------------------------- bash tab completion -----------------------

if ($ENV{'COMP_LINE'}) {
  map {/^$ARGV[0]/ and say $_} keys %actions;
  exit 0;
}

# -------------------------- normal execution -------------------------

# keep for checking action detection
# map {say "$_ -> $actions{$_}"} keys %actions;

# Just echo environment variables (all caps).
# (perl to the rescue for proper unicode regx)
if ($action =~ /^[\p{Lu}_]+$/) {
  say $ENV{$action};
  exit 0;
}

# Call local, approved internal subs if _.
if ($action =~ /^_/) {
  my $ref = $builtin{$action};
  if ($ref) {
    &$ref(@ARGV);
    exit 0;
  }
  say 'Builtin action not found: '.$action;
  exit -1
}

if (!$actions{$action}) {
  say 'No action found: ' . $action;
  exit -1;
}

$action_path = $actions{$action};
exec $action_path, @ARGV;

__END__
